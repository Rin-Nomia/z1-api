name: Deploy Z1 API to HuggingFace

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  HF_USERNAME: RinNomia  # æ”¹æˆä½ çš„ HuggingFace ç”¨æˆ¶å
  HF_SPACE_NAME: z1-tone-api     # Space åç¨±

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      # é—œå¡ 1ï¼šæŠ“å– Repo
      - name: Checkout repository
        uses: actions/checkout@v4
      
      # é—œå¡ 2ï¼šè¨­å®š Python
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      
      # é—œå¡ 3ï¼šå®‰è£ HuggingFace CLI
      - name: Install HuggingFace CLI
        run: |
          pip install huggingface_hub
      
      # é—œå¡ 4ï¼šéƒ¨ç½²åˆ° HuggingFace Spaces
      - name: Deploy to HuggingFace
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          echo "ğŸš€ éƒ¨ç½² Z1 API åˆ° HuggingFace Spaces"
          
          # ç™»å…¥ HuggingFace
          huggingface-cli login --token $HF_TOKEN
          
          # ä¸Šå‚³æª”æ¡ˆåˆ° Space
          huggingface-cli upload \
            ${{ env.HF_USERNAME }}/${{ env.HF_SPACE_NAME }} \
            . \
            --repo-type=space \
            --commit-message="Update Z1 API"
          
          echo "âœ… éƒ¨ç½²å®Œæˆ"
          echo "ğŸ“ API URL: https://huggingface.co/spaces/${{ env.HF_USERNAME }}/${{ env.HF_SPACE_NAME }}"
      
      # é—œå¡ 5ï¼šæ¸¬è©¦ API
      - name: Test deployed API
        run: |
          sleep 30  # ç­‰å¾…éƒ¨ç½²å®Œæˆ
          
          API_URL="https://${{ env.HF_USERNAME }}-${{ env.HF_SPACE_NAME }}.hf.space"
          
          echo "ğŸ§ª æ¸¬è©¦ API å¥åº·æª¢æŸ¥"
          curl -f "$API_URL/health" || echo "âš ï¸ å¥åº·æª¢æŸ¥å¤±æ•—"
          
          echo "ğŸ§ª æ¸¬è©¦åˆ†æç«¯é»"
          curl -X POST "$API_URL/api/v1/analyze" \
            -H "Content-Type: application/json" \
            -d '{"text": "æ¸¬è©¦æ–‡å­—"}' \
            || echo "âš ï¸ åˆ†ææ¸¬è©¦å¤±æ•—"

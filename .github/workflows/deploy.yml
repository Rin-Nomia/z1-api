name: Deploy Z1 API to HuggingFace

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  HF_USERNAME: RinNomia
  HF_SPACE_NAME: z1-tone-api

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      # é—œå¡ 1ï¼šæŠ“å– Repo
      - name: Checkout repository
        uses: actions/checkout@v4
      
      # é—œå¡ 2ï¼šè¨­å®š Python
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      
      # é—œå¡ 3ï¼šå®‰è£ä¾è³´
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install huggingface_hub[cli]
          pip install gitpython
      
      # é—œå¡ 3.5ï¼šæ¸¬è©¦ GitHub å‚™ä»½åŠŸèƒ½
      - name: Test GitHub Backup
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          GH_REPO: ${{ secrets.GH_REPO }}
        run: |
          echo "ğŸ§ª æ¸¬è©¦ GitHub å‚™ä»½åŠŸèƒ½"
          echo "=" * 60
          
          # è¨­å®š git
          git config --global user.name "Z1 API Test"
          git config --global user.email "test@z1api.dev"
          
          # åŸ·è¡Œæ¸¬è©¦è…³æœ¬
          python << 'PYTEST'
          import os
          import json
          import subprocess
          from datetime import datetime
          
          print("ğŸ“‹ æ­¥é©Ÿ 1: æª¢æŸ¥ç’°å¢ƒè®Šæ•¸")
          print("-" * 60)
          
          gh_token = os.environ.get('GH_TOKEN')
          gh_repo = os.environ.get('GH_REPO')
          
          if not gh_token:
              print("âŒ GH_TOKEN æœªè¨­å®š")
              exit(1)
          print(f"âœ… GH_TOKEN å·²è¨­å®šï¼ˆé•·åº¦: {len(gh_token)}ï¼‰")
          
          if not gh_repo:
              print("âŒ GH_REPO æœªè¨­å®š")
              exit(1)
          print(f"âœ… GH_REPO å·²è¨­å®š: {gh_repo}")
          print()
          
          print("ğŸ“‹ æ­¥é©Ÿ 2: å»ºç«‹æ¸¬è©¦æ•¸æ“š")
          print("-" * 60)
          
          # å»ºç«‹ logs è³‡æ–™å¤¾
          os.makedirs('logs', exist_ok=True)
          
          # å¯«å…¥æ¸¬è©¦æ•¸æ“š
          test_data = {
              'timestamp': datetime.now().isoformat(),
              'input': {'text': 'GitHub backup test', 'length': 19},
              'output': {'freq_type': 'Test', 'confidence': 1.0},
              'metadata': {'test': True, 'source': 'github_actions'}
          }
          
          date_str = datetime.now().strftime('%Y-%m-%d')
          log_file = f'logs/analysis_{date_str}.jsonl'
          
          with open(log_file, 'a', encoding='utf-8') as f:
              f.write(json.dumps(test_data, ensure_ascii=False) + '\n')
          
          print(f"âœ… æ¸¬è©¦æ•¸æ“šå·²å¯«å…¥: {log_file}")
          print()
          
          print("ğŸ“‹ æ­¥é©Ÿ 3: åˆå§‹åŒ– Git")
          print("-" * 60)
          
          os.chdir('logs')
          
          # Git åˆå§‹åŒ–
          subprocess.run(['git', 'init'], check=True)
          subprocess.run(['git', 'config', 'user.name', 'Z1 API Test'], check=True)
          subprocess.run(['git', 'config', 'user.email', 'test@z1api.dev'], check=True)
          
          # è¨­å®š remote
          remote_url = f'https://{gh_token}@github.com/{gh_repo}.git'
          subprocess.run(['git', 'remote', 'add', 'origin', remote_url], 
                        stderr=subprocess.DEVNULL)
          
          print("âœ… Git åˆå§‹åŒ–å®Œæˆ")
          print()
          
          print("ğŸ“‹ æ­¥é©Ÿ 4: æäº¤ä¸¦æ¨é€")
          print("-" * 60)
          
          subprocess.run(['git', 'add', '.'], check=True)
          subprocess.run(['git', 'commit', '-m', 
                         f'Test backup from GitHub Actions [{datetime.now().isoformat()}]'],
                        check=True)
          
          result = subprocess.run(['git', 'push', '-u', 'origin', 'main', '--force'],
                                 capture_output=True, text=True)
          
          if result.returncode == 0:
              print("âœ… æ¨é€æˆåŠŸï¼")
          else:
              print(f"âŒ æ¨é€å¤±æ•—: {result.stderr}")
              exit(1)
          
          print()
          print("=" * 60)
          print("âœ… GitHub å‚™ä»½æ¸¬è©¦å®Œæˆï¼")
          print("=" * 60)
          print()
          print(f"ğŸ“ é©—è­‰é€£çµ: https://github.com/{gh_repo}")
          print(f"   æ‡‰è©²æœƒçœ‹åˆ° analysis_{date_str}.jsonl")
          print("=" * 60)
          PYTEST
      
      # é—œå¡ 4ï¼šéƒ¨ç½²åˆ° HuggingFace Spaces
      - name: Deploy to HuggingFace
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          python << 'PYDEPLOY'
          import os
          from huggingface_hub import HfApi
          from datetime import datetime
          
          # å–å¾—ç’°å¢ƒè®Šæ•¸
          token = os.environ['HF_TOKEN']
          username = os.environ['HF_USERNAME']
          space_name = os.environ['HF_SPACE_NAME']
          repo_id = f"{username}/{space_name}"
          
          print(f"ğŸš€ éƒ¨ç½² Z1 API åˆ° HuggingFace Space: {repo_id}")
          print()
          
          # åˆå§‹åŒ– API
          api = HfApi(token=token)
          
          # æª¢æŸ¥ Space æ˜¯å¦å­˜åœ¨
          try:
              api.space_info(repo_id)
              print(f"âœ… Space å·²å­˜åœ¨ï¼š{repo_id}")
          except Exception as e:
              print(f"âš ï¸  Space ä¸å­˜åœ¨ï¼Œå°‡è‡ªå‹•å»ºç«‹")
              try:
                  api.create_repo(
                      repo_id=repo_id,
                      repo_type="space",
                      space_sdk="docker"
                  )
                  print(f"âœ… Space å»ºç«‹æˆåŠŸï¼š{repo_id}")
              except Exception as create_error:
                  print(f"âŒ ç„¡æ³•å»ºç«‹ Spaceï¼š{create_error}")
                  exit(1)
          
          print()
          print("ğŸ“¤ ä¸Šå‚³æª”æ¡ˆä¸­...")
          
          # ä¸Šå‚³è³‡æ–™å¤¾
          try:
              api.upload_folder(
                  folder_path=".",
                  repo_id=repo_id,
                  repo_type="space",
                  commit_message=f"Auto deploy [{datetime.now().strftime('%Y-%m-%d %H:%M:%S')}]",
                  ignore_patterns=[".git", ".github", "*.pyc", "__pycache__", "logs"]
              )
              print("âœ… ä¸Šå‚³æˆåŠŸï¼")
          except Exception as e:
              print(f"âŒ ä¸Šå‚³å¤±æ•—ï¼š{e}")
              exit(1)
          
          print()
          print("=" * 50)
          print("ğŸ‰ éƒ¨ç½²å®Œæˆï¼")
          print("=" * 50)
          print()
          print("ğŸ“ Space URL:")
          print(f"   https://huggingface.co/spaces/{repo_id}")
          print()
          print("ğŸ“ API ç«¯é»ï¼š")
          print(f"   https://{username}-{space_name}.hf.space/health")
          print(f"   https://{username}-{space_name}.hf.space/docs")
          print()
          print("â³ æ³¨æ„ï¼šSpace éœ€è¦ 2-5 åˆ†é˜å•Ÿå‹•")
          print("=" * 50)
          PYDEPLOY
      
      # é—œå¡ 5ï¼šç­‰å¾…ä¸¦æ¸¬è©¦ API
      - name: Test deployed API
        run: |
          echo "â³ ç­‰å¾… Space å•Ÿå‹•ï¼ˆ60 ç§’ï¼‰..."
          sleep 60
          
          API_URL="https://${{ env.HF_USERNAME }}-${{ env.HF_SPACE_NAME }}.hf.space"
          
          echo ""
          echo "ğŸ§ª æ¸¬è©¦ API å¥åº·æª¢æŸ¥"
          curl -f "$API_URL/health" || echo "âš ï¸  API å°šæœªå°±ç·’ï¼Œè«‹ç¨å¾Œæ‰‹å‹•æ¸¬è©¦"
          
          echo ""
          echo "ğŸ§ª æ¸¬è©¦å‚™ä»½ç«¯é»"
          curl -X POST -f "$API_URL/api/v1/test-backup" || echo "âš ï¸  æ¸¬è©¦ç«¯é»å°šæœªå°±ç·’"

name: Deploy Continuum API to HuggingFace

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  HF_USERNAME: RinNomia
  HF_SPACE_NAME: continuum-api

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install "huggingface_hub>=0.20.0"
          pip install gitpython
      
      - name: Test GitHub Backup
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          GH_REPO: ${{ secrets.GH_REPO }}
        run: |
          echo "ðŸ§ª æ¸¬è©¦ GitHub å‚™ä»½åŠŸèƒ½"
          
          git config --global user.name "Continuum API Test"
          git config --global user.email "test@continuum-api.dev"
          git config --global init.defaultBranch main
          
          python << 'PYTEST'
          import os
          import json
          import subprocess
          from datetime import datetime
          
          print("ðŸ“‹ æ­¥é©Ÿ 1: æª¢æŸ¥ç’°å¢ƒè®Šæ•¸")
          print("-" * 60)
          
          gh_token = os.environ.get('GH_TOKEN')
          gh_repo = os.environ.get('GH_REPO')
          
          if not gh_token:
              print("âŒ GH_TOKEN æœªè¨­å®š")
              exit(1)
          print(f"âœ… GH_TOKEN å·²è¨­å®šï¼ˆé•·åº¦: {len(gh_token)}ï¼‰")
          
          if not gh_repo:
              print("âŒ GH_REPO æœªè¨­å®š")
              exit(1)
          print(f"âœ… GH_REPO å·²è¨­å®š: {gh_repo}")
          print()
          
          print("ðŸ“‹ æ­¥é©Ÿ 2: å»ºç«‹æ¸¬è©¦æ•¸æ“š")
          print("-" * 60)
          
          os.makedirs('logs', exist_ok=True)
          
          test_data = {
              'timestamp': datetime.now().isoformat(),
              'input': {'text': 'GitHub backup test', 'length': 19},
              'output': {'freq_type': 'Test', 'confidence': 1.0},
              'metadata': {'test': True, 'source': 'github_actions'}
          }
          
          date_str = datetime.now().strftime('%Y-%m-%d')
          log_file = f'logs/analysis_{date_str}.jsonl'
          
          with open(log_file, 'a', encoding='utf-8') as f:
              f.write(json.dumps(test_data, ensure_ascii=False) + '\n')
          
          print(f"âœ… æ¸¬è©¦æ•¸æ“šå·²å¯«å…¥: {log_file}")
          print()
          
          print("ðŸ“‹ æ­¥é©Ÿ 3: åˆå§‹åŒ– Git")
          print("-" * 60)
          
          os.chdir('logs')
          
          subprocess.run(['git', 'init', '-b', 'main'], check=True)
          subprocess.run(['git', 'config', 'user.name', 'Continuum API Test'], check=True)
          subprocess.run(['git', 'config', 'user.email', 'test@continuum-api.dev'], check=True)
          
          remote_url = f'https://{gh_token}@github.com/{gh_repo}.git'
          subprocess.run(['git', 'remote', 'add', 'origin', remote_url], 
                        stderr=subprocess.DEVNULL)
          
          print("âœ… Git åˆå§‹åŒ–å®Œæˆ")
          print()
          
          print("ðŸ“‹ æ­¥é©Ÿ 4: æäº¤ä¸¦æŽ¨é€")
          print("-" * 60)
          
          subprocess.run(['git', 'add', '.'], check=True)
          subprocess.run(['git', 'commit', '-m', 
                         f'Test backup from GitHub Actions [{datetime.now().isoformat()}]'],
                        check=True)
          
          result = subprocess.run(['git', 'push', '-u', 'origin', 'main', '--force'],
                                 capture_output=True, text=True)
          
          if result.returncode == 0:
              print("âœ… æŽ¨é€æˆåŠŸï¼")
          else:
              print(f"âŒ æŽ¨é€å¤±æ•—: {result.stderr}")
              exit(1)
          
          print()
          print("=" * 60)
          print("âœ… GitHub å‚™ä»½æ¸¬è©¦å®Œæˆï¼")
          print("=" * 60)
          print()
          print(f"ðŸ“ é©—è­‰é€£çµ: https://github.com/{gh_repo}")
          print(f"   æ‡‰è©²æœƒçœ‹åˆ° analysis_{date_str}.jsonl")
          print("=" * 60)
          PYTEST
      
      - name: Deploy to HuggingFace
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          python << 'PYDEPLOY'
          import os
          import time
          from huggingface_hub import HfApi
          from datetime import datetime
          
          token = os.environ['HF_TOKEN']
          username = os.environ['HF_USERNAME']
          space_name = os.environ['HF_SPACE_NAME']
          repo_id = f"{username}/{space_name}"
          
          print(f"ðŸš€ éƒ¨ç½² Continuum API åˆ° HuggingFace Space: {repo_id}")
          print()
          
          api = HfApi(token=token)
          
          try:
              api.space_info(repo_id)
              print(f"âœ… Space å·²å­˜åœ¨ï¼š{repo_id}")
          except Exception:
              print(f"âš ï¸  Space ä¸å­˜åœ¨ï¼Œå°‡è‡ªå‹•å»ºç«‹")
              try:
                  api.create_repo(
                      repo_id=repo_id,
                      repo_type="space",
                      space_sdk="docker"
                  )
                  print(f"âœ… Space å»ºç«‹æˆåŠŸï¼š{repo_id}")
              except Exception as e:
                  print(f"âŒ ç„¡æ³•å»ºç«‹ Spaceï¼š{e}")
                  exit(1)
          
          print()
          print("ðŸ“¤ ä¸Šå‚³æª”æ¡ˆä¸­...")
          print("â³ é€™å¯èƒ½éœ€è¦ 1-3 åˆ†é˜...")
          
          max_retries = 3
          retry_delay = 10
          
          for attempt in range(max_retries):
              try:
                  print(f"   å˜—è©¦ {attempt + 1}/{max_retries}...")
                  
                  api.upload_folder(
                      folder_path=".",
                      repo_id=repo_id,
                      repo_type="space",
                      commit_message=f"Auto deploy [{datetime.now().strftime('%Y-%m-%d %H:%M:%S')}]",
                      ignore_patterns=[
                          ".git",
                          ".github",
                          "*.pyc",
                          "__pycache__",
                          "logs",
                          ".gitignore",
                          "README.md"
                      ]
                  )
                  
                  print("âœ… ä¸Šå‚³æˆåŠŸï¼")
                  break
                  
              except Exception as e:
                  error_msg = str(e)
                  print(f"âš ï¸  å˜—è©¦ {attempt + 1} å¤±æ•—ï¼š{error_msg}")
                  
                  if attempt < max_retries - 1:
                      print(f"   {retry_delay} ç§’å¾Œé‡è©¦...")
                      time.sleep(retry_delay)
                      retry_delay *= 2
                  else:
                      print(f"âŒ ä¸Šå‚³å¤±æ•—ï¼ˆå·²é‡è©¦ {max_retries} æ¬¡ï¼‰")
                      print(f"   æœ€å¾ŒéŒ¯èª¤ï¼š{error_msg}")
                      exit(1)
          
          print()
          print("=" * 50)
          print("ðŸŽ‰ éƒ¨ç½²å®Œæˆï¼")
          print("=" * 50)
          print()
          print("ðŸ“ Space URL:")
          print(f"   https://huggingface.co/spaces/{repo_id}")
          print()
          print("ðŸ“ API ç«¯é»žï¼š")
          print(f"   https://rinnomia-{space_name}.hf.space/health")
          print(f"   https://rinnomia-{space_name}.hf.space/docs")
          print()
          print("â³ æ³¨æ„ï¼šSpace éœ€è¦ 2-5 åˆ†é˜å•Ÿå‹•")
          print("=" * 50)
          PYDEPLOY
      
      - name: Test deployed API
        run: |
          echo "â³ ç­‰å¾… Space å•Ÿå‹•ï¼ˆ60 ç§’ï¼‰..."
          sleep 60
          
          API_URL="https://rinnomia-${{ env.HF_SPACE_NAME }}.hf.space"
          
          echo ""
          echo "ðŸ§ª æ¸¬è©¦ API å¥åº·æª¢æŸ¥"
          curl -f "$API_URL/health" || echo "âš ï¸  API å°šæœªå°±ç·’ï¼Œè«‹ç¨å¾Œæ‰‹å‹•æ¸¬è©¦"

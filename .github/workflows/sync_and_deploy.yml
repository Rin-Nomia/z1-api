name: åŒæ­¥ z1_mvp ä¸¦éƒ¨ç½² Continuum API

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  SOURCE_REPO: Rin-Nomia/z1_mvp
  HF_USERNAME: RinNomia
  HF_SPACE: continuum-api

jobs:
  sync_and_deploy:
    runs-on: ubuntu-latest
    
    steps:
      # é—œå¡ 1ï¼šæŠ“å–ç•¶å‰ repo (continuum-api)
      - name: é—œå¡ 1 - Checkout continuum-api
        uses: actions/checkout@v4
        with:
          path: continuum-api
      
      # é—œå¡ 2ï¼šæŠ“å– z1_mvp
      - name: é—œå¡ 2 - Checkout z1_mvp
        uses: actions/checkout@v4
        with:
          repository: ${{ env.SOURCE_REPO }}
          token: ${{ secrets.GH_PAT }}
          path: z1_mvp
      
      # é—œå¡ 3ï¼šè¤‡è£½è³‡æ–™å¤¾
      - name: é—œå¡ 3 - è¤‡è£½ pipeline, core, configs
        run: |
          echo "ğŸ“¦ é–‹å§‹è¤‡è£½è³‡æ–™å¤¾..."
          
          # å…ˆåˆªé™¤èˆŠçš„ (å¦‚æœå­˜åœ¨)
          rm -rf continuum-api/pipeline
          rm -rf continuum-api/core
          rm -rf continuum-api/configs
          
          # è¤‡è£½æ–°çš„
          cp -r z1_mvp/pipeline continuum-api/
          echo "âœ… pipeline/ å·²è¤‡è£½"
          
          cp -r z1_mvp/core continuum-api/
          echo "âœ… core/ å·²è¤‡è£½"
          
          cp -r z1_mvp/configs continuum-api/
          echo "âœ… configs/ å·²è¤‡è£½"
          
          echo ""
          echo "ğŸ“‚ æª”æ¡ˆçµæ§‹ï¼š"
          ls -lh continuum-api/
          
          echo ""
          echo "ğŸ“‚ ç¢ºèªé—œéµæª”æ¡ˆï¼š"
          ls -lh continuum-api/pipeline/
          ls -lh continuum-api/core/
          ls -lh continuum-api/configs/
      
      # é—œå¡ 4ï¼šè¨­å®š Python
      - name: é—œå¡ 4 - Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      
      # é—œå¡ 5ï¼šæ¸¬è©¦ Pipeline
      - name: é—œå¡ 5 - æ¸¬è©¦ Pipeline
        working-directory: continuum-api
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "ğŸ“¦ å®‰è£ä¾è³´..."
          pip install -r requirements.txt
          
          echo ""
          echo "ğŸ§ª æ¸¬è©¦ Pipeline"
          echo "================================"
          
          python << 'PYTEST'
          import sys
          import os
          
          # ç¢ºèªæª”æ¡ˆå­˜åœ¨
          print("ğŸ” æª¢æŸ¥æª”æ¡ˆ...")
          required_files = [
              'pipeline/z1_pipeline.py',
              'core/normalizer.py',
              'core/classifier.py',
              'configs/settings.yaml',
              'configs/keywords.json',
              'configs/templates.json'
          ]
          
          missing_files = []
          for file_path in required_files:
              if not os.path.exists(file_path):
                  missing_files.append(file_path)
                  print(f"âŒ ç¼ºå°‘: {file_path}")
              else:
                  print(f"âœ… å­˜åœ¨: {file_path}")
          
          if missing_files:
              print(f"\nâŒ ç¼ºå°‘ {len(missing_files)} å€‹æª”æ¡ˆï¼")
              exit(1)
          
          print("\nâœ… æ‰€æœ‰å¿…è¦æª”æ¡ˆéƒ½å­˜åœ¨")
          print()
          
          # æ¸¬è©¦ Pipeline
          from pipeline.z1_pipeline import Z1Pipeline
          
          print("åˆå§‹åŒ– Pipeline...")
          pipeline = Z1Pipeline(debug=True)
          print("âœ… Pipeline åˆå§‹åŒ–æˆåŠŸ")
          print()
          
          print("ğŸ§ª æ¸¬è©¦åˆ†æåŠŸèƒ½")
          test_text = "I don't know what to do anymore. Everything I try fails."
          result = pipeline.process(test_text)
          
          if result.get('error'):
              print(f"âŒ æ¸¬è©¦å¤±æ•—ï¼š{result.get('reason')}")
              exit(1)
          
          print(f"âœ… æ¸¬è©¦æˆåŠŸï¼")
          print(f"   é¡å‹ï¼š{result['freq_type']}")
          print(f"   ä¿¡å¿ƒå€¼ï¼š{result['confidence']['final']:.2f}")
          print(f"   å ´æ™¯ï¼š{result['output']['scenario']}")
          PYTEST
      
      # é—œå¡ 6ï¼šéƒ¨ç½²åˆ° HuggingFace
      - name: é—œå¡ 6 - éƒ¨ç½²åˆ° HuggingFace
        working-directory: continuum-api
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          echo "ğŸ“¦ å®‰è£ HuggingFace Hub..."
          pip install huggingface_hub
          
          echo ""
          echo "ğŸ“¤ é–‹å§‹éƒ¨ç½²åˆ° HuggingFace Space..."
          echo "================================"
          
          python << 'PYDEPLOY'
          import os
          from huggingface_hub import HfApi
          from datetime import datetime
          
          token = os.environ['HF_TOKEN']
          username = os.environ['HF_USERNAME']
          space_name = os.environ['HF_SPACE']
          repo_id = f"{username}/{space_name}"
          
          print(f"ğŸ“ ç›®æ¨™ Spaceï¼š{repo_id}")
          print()
          
          api = HfApi(token=token)
          
          # æª¢æŸ¥ Space æ˜¯å¦å­˜åœ¨
          try:
              space_info = api.space_info(repo_id)
              print(f"âœ… Space å·²å­˜åœ¨ï¼š{repo_id}")
              print(f"   Runtime: {space_info.runtime}")
              print(f"   SDK: {space_info.sdk}")
          except Exception as e:
              print(f"âš ï¸  Space ä¸å­˜åœ¨ï¼Œå°‡è‡ªå‹•å»ºç«‹")
              try:
                  api.create_repo(
                      repo_id=repo_id,
                      repo_type="space",
                      space_sdk="docker"
                  )
                  print(f"âœ… Space å»ºç«‹æˆåŠŸï¼š{repo_id}")
              except Exception as create_error:
                  print(f"âŒ ç„¡æ³•å»ºç«‹ Spaceï¼š{create_error}")
                  exit(1)
          
          print()
          print("ğŸ“¤ ä¸Šå‚³æª”æ¡ˆä¸­...")
          print("   é€™å¯èƒ½éœ€è¦ 1-2 åˆ†é˜...")
          
          try:
              # ä¸Šå‚³æ•´å€‹è³‡æ–™å¤¾
              commit_info = api.upload_folder(
                  folder_path=".",
                  repo_id=repo_id,
                  repo_type="space",
                  commit_message=f"Auto deploy Continuum API [{datetime.now().strftime('%Y-%m-%d %H:%M:%S')}]",
                  ignore_patterns=[
                      ".git",
                      ".github",
                      "*.pyc",
                      "__pycache__",
                      "logs",
                      ".gitignore"
                  ]
              )
              print("âœ… ä¸Šå‚³æˆåŠŸï¼")
              print(f"   Commit URL: {commit_info.commit_url}")
          except Exception as e:
              print(f"âŒ ä¸Šå‚³å¤±æ•—ï¼š{e}")
              import traceback
              traceback.print_exc()
              exit(1)
          
          print()
          print("=" * 60)
          print("ğŸ‰ éƒ¨ç½²å®Œæˆï¼")
          print("=" * 60)
          print()
          print("ğŸ“ Space URL:")
          print(f"   https://huggingface.co/spaces/{repo_id}")
          print()
          print("ğŸ“ API ç«¯é»ï¼š")
          username_lower = username.lower()
          print(f"   å¥åº·æª¢æŸ¥ï¼šhttps://{username_lower}-{space_name}.hf.space/health")
          print(f"   API æ–‡ä»¶ï¼šhttps://{username_lower}-{space_name}.hf.space/docs")
          print(f"   åˆ†æç«¯é»ï¼šhttps://{username_lower}-{space_name}.hf.space/api/v1/analyze")
          print()
          print("ğŸ§ª æ¸¬è©¦æŒ‡ä»¤ï¼š")
          print(f"   curl https://{username_lower}-{space_name}.hf.space/health")
          print()
          print("â³ æ³¨æ„ï¼šHuggingFace Space éœ€è¦ 2-5 åˆ†é˜å•Ÿå‹•")
          print("   è«‹ç¨å¾Œè¨ªå•ä¸Šé¢çš„ URL")
          print("=" * 60)
          PYDEPLOY
```

---

## **ä¸»è¦æ”¹å‹•:**

1. âœ… **åŠ äº†æª”æ¡ˆæª¢æŸ¥** - ç¢ºèªæ‰€æœ‰å¿…è¦æª”æ¡ˆéƒ½è¢«è¤‡è£½äº†
2. âœ… **å…ˆåˆªé™¤èˆŠæª”æ¡ˆ** - é¿å…è¡çª
3. âœ… **æ›´è©³ç´°çš„ log** - æ–¹ä¾¿ debug
4. âœ… **ä¿®æ­£ username** - æ”¹æˆå°å¯« (HuggingFace URL æ˜¯å°å¯«)
5. âœ… **åŠ äº† ignore_patterns** - ä¸ä¸Šå‚³ä¸éœ€è¦çš„æª”æ¡ˆ

---

## **ç¾åœ¨ç«‹åˆ»åš:**

### **Step 1: æª¢æŸ¥ HuggingFace Secrets**

**å»é€™è£¡:**
```
https://huggingface.co/spaces/RinNomia/continuum-api/settings
```

**å¾€ä¸‹æ»‘åˆ°ã€ŒVariables and secretsã€**

**ç¢ºèªæœ‰:**
```
ANTHROPIC_API_KEY = sk-ant-xxxxx
```

**å¦‚æœæ²’æœ‰,åŠ ä¸Šå»!**

---

### **Step 2: æ›´æ–° Workflow**

**ç”¨æˆ‘ä¸Šé¢çµ¦ä½ çš„å®Œæ•´ç‰ˆè¦†è“‹:**
```
.github/workflows/sync_and_deploy.yml

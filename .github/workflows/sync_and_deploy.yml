name: åŒæ­¥ z1_mvp ä¸¦éƒ¨ç½² API

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  SOURCE_REPO: Rin-Nomia/z1_mvp
  HF_USERNAME: Rin-Nomia
  HF_SPACE: z1-tone-api

jobs:
  sync_and_deploy:
    runs-on: ubuntu-latest
    
    steps:
      # é—œå¡ 1ï¼šæŠ“å–ç•¶å‰ repo (z1-api)
      - name: é—œå¡ 1 - Checkout z1-api
        uses: actions/checkout@v4
        with:
          path: z1-api
      
      # é—œå¡ 2ï¼šæŠ“å– z1_mvp
      - name: é—œå¡ 2 - Checkout z1_mvp
        uses: actions/checkout@v4
        with:
          repository: ${{ env.SOURCE_REPO }}
          token: ${{ secrets.GH_PAT }}
          path: z1_mvp
      
      # é—œå¡ 3ï¼šè¤‡è£½è³‡æ–™å¤¾ï¼ˆè‡ªå‹•åŒ–ï¼ï¼‰
      - name: é—œå¡ 3 - è¤‡è£½ pipeline, core, configs
        run: |
          echo "ğŸ“¦ é–‹å§‹è¤‡è£½è³‡æ–™å¤¾..."
          
          # è¤‡è£½ pipeline
          cp -r z1_mvp/pipeline z1-api/
          echo "âœ… pipeline/ å·²è¤‡è£½"
          
          # è¤‡è£½ core
          cp -r z1_mvp/core z1-api/
          echo "âœ… core/ å·²è¤‡è£½"
          
          # è¤‡è£½ configs
          cp -r z1_mvp/configs z1-api/
          echo "âœ… configs/ å·²è¤‡è£½"
          
          # æª¢æŸ¥æª”æ¡ˆ
          ls -lh z1-api/
      
      # é—œå¡ 4ï¼šè¨­å®š Python
      - name: é—œå¡ 4 - Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      
      # é—œå¡ 5ï¼šæ¸¬è©¦ Pipeline
      - name: é—œå¡ 5 - æ¸¬è©¦ Pipeline æ˜¯å¦æ­£å¸¸
        working-directory: z1-api
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          pip install -r requirements.txt
          
          # ç°¡å–®æ¸¬è©¦
          python -c "
          from pipeline.z1_pipeline import Z1Pipeline
          pipeline = Z1Pipeline(debug=True)
          result = pipeline.process('æ¸¬è©¦æ–‡å­—')
          print('âœ… Pipeline æ¸¬è©¦æˆåŠŸ')
          print(f'é¡å‹: {result[\"freq_type\"]}')
          print(f'ä¿¡å¿ƒå€¼: {result[\"confidence\"][\"final\"]:.2f}')
          "
      
      # é—œå¡ 6ï¼šéƒ¨ç½²åˆ° HuggingFace
      - name: é—œå¡ 6 - éƒ¨ç½²åˆ° HuggingFace
        working-directory: z1-api
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          pip install huggingface_hub
          
          huggingface-cli login --token $HF_TOKEN
          
          huggingface-cli upload \
            ${{ env.HF_USERNAME }}/${{ env.HF_SPACE }} \
            . \
            --repo-type=space \
            --commit-message="Auto deploy Z1 API"
          
          echo "âœ… éƒ¨ç½²å®Œæˆ"
          echo "ğŸ“ API URL: https://${{ env.HF_USERNAME }}-${{ env.HF_SPACE }}.hf.space"

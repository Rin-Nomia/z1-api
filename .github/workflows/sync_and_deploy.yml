name: åŒæ­¥ z1_mvp ä¸¦éƒ¨ç½² API

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  SOURCE_REPO: Rin-Nomia/z1_mvp
  HF_USERNAME: RinNomia
  HF_SPACE: z1-tone-api

jobs:
  sync_and_deploy:
    runs-on: ubuntu-latest
    
    steps:
      # é—œå¡ 1ï¼šæŠ“å–ç•¶å‰ repo (z1-api)
      - name: é—œå¡ 1 - Checkout z1-api
        uses: actions/checkout@v4
        with:
          path: z1-api
      
      # é—œå¡ 2ï¼šæŠ“å– z1_mvp
      - name: é—œå¡ 2 - Checkout z1_mvp
        uses: actions/checkout@v4
        with:
          repository: ${{ env.SOURCE_REPO }}
          token: ${{ secrets.GH_PAT }}
          path: z1_mvp
      
      # é—œå¡ 3ï¼šè¤‡è£½è³‡æ–™å¤¾ï¼ˆè‡ªå‹•åŒ–ï¼ï¼‰
      - name: é—œå¡ 3 - è¤‡è£½ pipeline, core, configs
        run: |
          echo "ğŸ“¦ é–‹å§‹è¤‡è£½è³‡æ–™å¤¾..."
          
          # è¤‡è£½ pipeline
          cp -r z1_mvp/pipeline z1-api/
          echo "âœ… pipeline/ å·²è¤‡è£½"
          
          # è¤‡è£½ core
          cp -r z1_mvp/core z1-api/
          echo "âœ… core/ å·²è¤‡è£½"
          
          # è¤‡è£½ configs
          cp -r z1_mvp/configs z1-api/
          echo "âœ… configs/ å·²è¤‡è£½"
          
          # æª¢æŸ¥æª”æ¡ˆ
          echo ""
          echo "ğŸ“‚ æª”æ¡ˆçµæ§‹ï¼š"
          ls -lh z1-api/
          echo ""
          echo "ğŸ“‚ pipeline å…§å®¹ï¼š"
          ls -lh z1-api/pipeline/
          echo ""
          echo "ğŸ“‚ core å…§å®¹ï¼š"
          ls -lh z1-api/core/
          echo ""
          echo "ğŸ“‚ configs å…§å®¹ï¼š"
          ls -lh z1-api/configs/
      
      # é—œå¡ 4ï¼šè¨­å®š Python
      - name: é—œå¡ 4 - Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      
      # é—œå¡ 5ï¼šæ¸¬è©¦ Pipelineï¼ˆä¿®æ­£ç‰ˆï¼‰
      - name: é—œå¡ 5 - æ¸¬è©¦ Pipeline æ˜¯å¦æ­£å¸¸
        working-directory: z1-api
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "ğŸ“¦ å®‰è£ä¾è³´..."
          pip install -r requirements.txt
          
          echo ""
          echo "ğŸ§ª é–‹å§‹æ¸¬è©¦ Pipeline"
          echo "================================"
          
          # æ¸¬è©¦ Pipelineï¼ˆå«éŒ¯èª¤è™•ç†ï¼‰
          python << 'PYTEST'
          from pipeline.z1_pipeline import Z1Pipeline
          import json
          
          print("åˆå§‹åŒ– Pipeline...")
          pipeline = Z1Pipeline(debug=True)
          print("âœ… Pipeline åˆå§‹åŒ–æˆåŠŸ")
          print()
          
          # æ¸¬è©¦ 1ï¼šçŸ­æ–‡å­—ï¼ˆå¯èƒ½å¤ªçŸ­ï¼‰
          print("ğŸ§ª æ¸¬è©¦ 1ï¼šçŸ­æ–‡å­—")
          print("-" * 50)
          result1 = pipeline.process('æ¸¬è©¦æ–‡å­—')
          
          if result1.get('error'):
              print(f"âš ï¸  çŸ­æ–‡å­—è§¸ç™¼éŒ¯èª¤ï¼ˆé€™æ˜¯æ­£å¸¸çš„ï¼‰")
              print(f"   åŸå› ï¼š{result1.get('reason')}")
              print(f"   æœ€å°é•·åº¦è¦æ±‚ï¼šå¯èƒ½éœ€è¦æ›´é•·çš„æ–‡å­—")
          else:
              print(f"âœ… çŸ­æ–‡å­—æ¸¬è©¦æˆåŠŸ")
              print(f"   é¡å‹ï¼š{result1['freq_type']}")
              print(f"   ä¿¡å¿ƒå€¼ï¼š{result1['confidence']['final']:.2f}")
          
          print()
          
          # æ¸¬è©¦ 2ï¼šæ­£å¸¸é•·åº¦æ–‡å­—ï¼ˆæ¨™æº–æ¸¬è©¦æ¡ˆä¾‹ï¼‰
          print("ğŸ§ª æ¸¬è©¦ 2ï¼šæ­£å¸¸é•·åº¦æ–‡å­—")
          print("-" * 50)
          test_text = "I don't know what to do anymore. Everything I try fails. Can someone please help me?"
          print(f"æ¸¬è©¦æ–‡å­—ï¼š{test_text}")
          print()
          
          result2 = pipeline.process(test_text)
          
          if result2.get('error'):
              print(f"âŒ Pipeline æ¸¬è©¦å¤±æ•—")
              print(f"   éŒ¯èª¤åŸå› ï¼š{result2.get('reason')}")
              print(f"   å®Œæ•´çµæœï¼š{json.dumps(result2, indent=2, ensure_ascii=False)}")
              exit(1)
          else:
              print(f"âœ… Pipeline æ¸¬è©¦æˆåŠŸï¼")
              print()
              print(f"ğŸ“Š åˆ†æçµæœï¼š")
              print(f"   é¡å‹ï¼š{result2['freq_type']}")
              print(f"   ä¿¡å¿ƒå€¼ï¼š{result2['confidence']['final']:.2f}")
              print(f"   å ´æ™¯ï¼š{result2['output']['scenario']}")
              print(f"   å ´æ™¯ä¿¡å¿ƒï¼š{result2['output']['scenario_confidence']:.2f}")
              
              if result2['output'].get('repaired_text'):
                  print(f"   ä¿®å¾©æ–‡å­—ï¼š{result2['output']['repaired_text'][:80]}...")
              
              print()
              print(f"ğŸ‰ æ‰€æœ‰æ¸¬è©¦é€šéï¼API å¯ä»¥æ­£å¸¸é‹ä½œ")
          PYTEST
      
      # é—œå¡ 6ï¼šéƒ¨ç½²åˆ° HuggingFace
      - name: é—œå¡ 6 - éƒ¨ç½²åˆ° HuggingFace
        working-directory: z1-api
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          echo "ğŸ“¦ å®‰è£ HuggingFace CLI..."
          pip install huggingface_hub
          
          echo ""
          echo "ğŸ” ç™»å…¥ HuggingFace..."
          huggingface-cli login --token $HF_TOKEN
          
          echo ""
          echo "ğŸ“¤ ä¸Šå‚³åˆ° HuggingFace Space..."
          huggingface-cli upload \
            ${{ env.HF_USERNAME }}/${{ env.HF_SPACE }} \
            . \
            --repo-type=space \
            --commit-message="Auto deploy Z1 API [$(date +'%Y-%m-%d %H:%M:%S')]"
          
          echo ""
          echo "================================"
          echo "âœ… éƒ¨ç½²å®Œæˆï¼"
          echo "================================"
          echo ""
          echo "ğŸ“ API ç«¯é»ï¼š"
          echo "   å¥åº·æª¢æŸ¥ï¼šhttps://${{ env.HF_USERNAME }}-${{ env.HF_SPACE }}.hf.space/health"
          echo "   API æ–‡ä»¶ï¼šhttps://${{ env.HF_USERNAME }}-${{ env.HF_SPACE }}.hf.space/docs"
          echo "   åˆ†æç«¯é»ï¼šhttps://${{ env.HF_USERNAME }}-${{ env.HF_SPACE }}.hf.space/api/v1/analyze"
          echo ""
          echo "ğŸ§ª æ¸¬è©¦æŒ‡ä»¤ï¼š"
          echo "   curl https://${{ env.HF_USERNAME }}-${{ env.HF_SPACE }}.hf.space/health"
          echo ""
          echo "â³ æ³¨æ„ï¼šHuggingFace Space éœ€è¦ 2-5 åˆ†é˜å•Ÿå‹•"
          echo "================================"

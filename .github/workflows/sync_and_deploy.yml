name: åŒæ­¥ z1_mvp ä¸¦éƒ¨ç½² Continuum API (deploy-safe-split)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  SOURCE_REPO: Rin-Nomia/z1_mvp
  HF_USERNAME: RinNomia
  HF_SPACE: continuum-api

  # â±ï¸ HF Hub timeoutï¼ˆä¿ç•™ï¼‰
  HF_HUB_ETAG_TIMEOUT: "60"
  HF_HUB_DOWNLOAD_TIMEOUT: "60"

jobs:
  sync_and_deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 25

    steps:
      # é—œå¡ 1ï¼šæŠ“å– continuum-api
      - name: é—œå¡ 1 - Checkout continuum-api
        uses: actions/checkout@v4
        with:
          path: continuum-api

      # é—œå¡ 2ï¼šæŠ“å– z1_mvp
      - name: é—œå¡ 2 - Checkout z1_mvp
        uses: actions/checkout@v4
        with:
          repository: ${{ env.SOURCE_REPO }}
          token: ${{ secrets.GH_PAT }}
          path: z1_mvp

      # é—œå¡ 3ï¼šè¤‡è£½æ ¸å¿ƒè³‡æ–™å¤¾
      - name: é—œå¡ 3 - è¤‡è£½ pipeline, core, configs
        run: |
          echo "ğŸ“¦ åŒæ­¥æ ¸å¿ƒæ¨¡çµ„..."
          rm -rf continuum-api/pipeline continuum-api/core continuum-api/configs

          cp -r z1_mvp/pipeline continuum-api/
          cp -r z1_mvp/core continuum-api/
          cp -r z1_mvp/configs continuum-api/

          echo "âœ… åŒæ­¥å®Œæˆ"
          ls -lh continuum-api/

      # é—œå¡ 4ï¼šè¨­å®š Python
      - name: é—œå¡ 4 - Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # é—œå¡ 5ï¼šPipeline æ¸¬è©¦ï¼ˆä¸å‹•ï¼‰
      - name: é—œå¡ 5 - æ¸¬è©¦ Pipeline
        working-directory: continuum-api
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          pip install -r requirements.txt

          python << 'PYTEST'
          from pipeline.z1_pipeline import Z1Pipeline
          pipeline = Z1Pipeline(debug=True)

          text = "I don't know what to do anymore. Everything I try fails."
          result = pipeline.process(text)

          if result.get("error"):
              raise SystemExit("âŒ Pipeline æ¸¬è©¦å¤±æ•—")

          print("âœ… Pipeline OK")
          PYTEST

      # é—œå¡ 5.5ï¼šå»ºç«‹ä¹¾æ·¨ dist/
      - name: é—œå¡ 5.5 - å»ºç«‹ dist/
        working-directory: continuum-api
        run: |
          rm -rf dist
          mkdir dist

          rsync -av \
            --exclude ".git" \
            --exclude "logs" \
            --exclude "__pycache__" \
            --exclude "*.pyc" \
            --exclude ".pytest_cache" \
            --exclude ".mypy_cache" \
            --exclude ".venv" \
            --exclude "venv" \
            --exclude "node_modules" \
            --exclude "*.parquet" \
            --exclude "*.jsonl" \
            --exclude "*.mp4" \
            --exclude "*.mov" \
            --exclude "*.zip" \
            ./ dist/

          echo "ğŸ“¦ dist å¤§å°ï¼š"
          du -sh dist

      # é—œå¡ 6ï¼šéƒ¨ç½²åˆ° HuggingFaceï¼ˆåˆ†æ‰¹ä¸Šå‚³ï¼Œé˜² timeoutï¼‰
      - name: é—œå¡ 6 - Deploy to HuggingFace (split upload)
        working-directory: continuum-api
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          pip install huggingface_hub

          python << 'PYDEPLOY'
          import os, time
          from huggingface_hub import HfApi
          from datetime import datetime

          token = os.environ["HF_TOKEN"]
          repo_id = f"{os.environ['HF_USERNAME']}/{os.environ['HF_SPACE']}"

          api = HfApi(token=token)

          try:
              api.space_info(repo_id)
          except Exception:
              api.create_repo(repo_id=repo_id, repo_type="space", space_sdk="docker")

          print("ğŸ“¤ åˆ†æ‰¹ä¸Šå‚³ dist å…§å®¹...")

          files = ["app.py", "Dockerfile", "requirements.txt", "README.md"]
          folders = ["pipeline", "core", "configs", "utils"]

          for f in files:
              path = f"dist/{f}"
              if os.path.exists(path):
                  for i in range(3):
                      try:
                          api.upload_file(
                              path_or_fileobj=path,
                              path_in_repo=f,
                              repo_id=repo_id,
                              repo_type="space",
                              commit_message=f"deploy {f}",
                          )
                          print(f"âœ… {f}")
                          break
                      except Exception as e:
                          print(f"âš ï¸ {f} retry {i+1}")
                          time.sleep(3)

          for folder in folders:
              path = f"dist/{folder}"
              if os.path.exists(path):
                  for i in range(3):
                      try:
                          api.upload_folder(
                              folder_path=path,
                              path_in_repo=folder,
                              repo_id=repo_id,
                              repo_type="space",
                              commit_message=f"deploy {folder}/",
                          )
                          print(f"âœ… {folder}/")
                          break
                      except Exception as e:
                          print(f"âš ï¸ {folder}/ retry {i+1}")
                          time.sleep(5)

          print("ğŸ‰ éƒ¨ç½²å®Œæˆ")
          PYDEPLOY
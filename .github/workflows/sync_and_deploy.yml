name: åŒæ­¥ z1_mvp ä¸¦éƒ¨ç½² API

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  SOURCE_REPO: Rin-Nomia/z1_mvp
  HF_USERNAME: RinNomia
  HF_SPACE: continuum-api

jobs:
  sync_and_deploy:
    runs-on: ubuntu-latest
    
    steps:
      # é—œå¡ 1ï¼šæŠ“å–ç•¶å‰ repo (z1-api)
      - name: é—œå¡ 1 - Checkout z1-api
        uses: actions/checkout@v4
        with:
          path: z1-api
      
      # é—œå¡ 2ï¼šæŠ“å– z1_mvp
      - name: é—œå¡ 2 - Checkout z1_mvp
        uses: actions/checkout@v4
        with:
          repository: ${{ env.SOURCE_REPO }}
          token: ${{ secrets.GH_PAT }}
          path: z1_mvp
      
      # é—œå¡ 3ï¼šè¤‡è£½è³‡æ–™å¤¾
      - name: é—œå¡ 3 - è¤‡è£½ pipeline, core, configs
        run: |
          echo "ğŸ“¦ é–‹å§‹è¤‡è£½è³‡æ–™å¤¾..."
          
          cp -r z1_mvp/pipeline z1-api/
          echo "âœ… pipeline/ å·²è¤‡è£½"
          
          cp -r z1_mvp/core z1-api/
          echo "âœ… core/ å·²è¤‡è£½"
          
          cp -r z1_mvp/configs z1-api/
          echo "âœ… configs/ å·²è¤‡è£½"
          
          echo ""
          echo "ğŸ“‚ æª”æ¡ˆçµæ§‹ï¼š"
          ls -lh z1-api/
      
      # é—œå¡ 4ï¼šè¨­å®š Python
      - name: é—œå¡ 4 - Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      
      # é—œå¡ 5ï¼šæ¸¬è©¦ Pipeline
      - name: é—œå¡ 5 - æ¸¬è©¦ Pipeline
        working-directory: z1-api
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "ğŸ“¦ å®‰è£ä¾è³´..."
          pip install -r requirements.txt
          
          echo ""
          echo "ğŸ§ª æ¸¬è©¦ Pipeline"
          echo "================================"
          
          python << 'PYTEST'
          from pipeline.z1_pipeline import Z1Pipeline
          
          print("åˆå§‹åŒ– Pipeline...")
          pipeline = Z1Pipeline(debug=True)
          print("âœ… Pipeline åˆå§‹åŒ–æˆåŠŸ")
          print()
          
          print("ğŸ§ª æ¸¬è©¦åˆ†æåŠŸèƒ½")
          test_text = "I don't know what to do anymore. Everything I try fails."
          result = pipeline.process(test_text)
          
          if result.get('error'):
              print(f"âŒ æ¸¬è©¦å¤±æ•—ï¼š{result.get('reason')}")
              exit(1)
          
          print(f"âœ… æ¸¬è©¦æˆåŠŸï¼")
          print(f"   é¡å‹ï¼š{result['freq_type']}")
          print(f"   ä¿¡å¿ƒå€¼ï¼š{result['confidence']['final']:.2f}")
          print(f"   å ´æ™¯ï¼š{result['output']['scenario']}")
          PYTEST
      
      # é—œå¡ 6ï¼šéƒ¨ç½²åˆ° HuggingFaceï¼ˆPython API ç‰ˆæœ¬ï¼‰
      - name: é—œå¡ 6 - éƒ¨ç½²åˆ° HuggingFace
        working-directory: z1-api
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          echo "ğŸ“¦ å®‰è£ HuggingFace Hub..."
          pip install huggingface_hub
          
          echo ""
          echo "ğŸ“¤ é–‹å§‹éƒ¨ç½²åˆ° HuggingFace Space..."
          echo "================================"
          
          python << 'PYDEPLOY'
          import os
          from huggingface_hub import HfApi
          from datetime import datetime
          
          # å–å¾—ç’°å¢ƒè®Šæ•¸
          token = os.environ['HF_TOKEN']
          username = os.environ['HF_USERNAME']
          space_name = os.environ['HF_SPACE']
          repo_id = f"{username}/{space_name}"
          
          print(f"ğŸ“ ç›®æ¨™ Spaceï¼š{repo_id}")
          print()
          
          # åˆå§‹åŒ– API
          api = HfApi(token=token)
          
          # æª¢æŸ¥ Space æ˜¯å¦å­˜åœ¨
          try:
              api.space_info(repo_id)
              print(f"âœ… Space å·²å­˜åœ¨ï¼š{repo_id}")
          except Exception as e:
              print(f"âš ï¸  Space ä¸å­˜åœ¨ï¼Œå°‡è‡ªå‹•å»ºç«‹")
              try:
                  api.create_repo(
                      repo_id=repo_id,
                      repo_type="space",
                      space_sdk="docker"
                  )
                  print(f"âœ… Space å»ºç«‹æˆåŠŸï¼š{repo_id}")
              except Exception as create_error:
                  print(f"âŒ ç„¡æ³•å»ºç«‹ Spaceï¼š{create_error}")
                  exit(1)
          
          print()
          print("ğŸ“¤ ä¸Šå‚³æª”æ¡ˆä¸­...")
          
          # ä¸Šå‚³è³‡æ–™å¤¾
          try:
              api.upload_folder(
                  folder_path=".",
                  repo_id=repo_id,
                  repo_type="space",
                  commit_message=f"Auto deploy Z1 API [{datetime.now().strftime('%Y-%m-%d %H:%M:%S')}]"
              )
              print("âœ… ä¸Šå‚³æˆåŠŸï¼")
          except Exception as e:
              print(f"âŒ ä¸Šå‚³å¤±æ•—ï¼š{e}")
              exit(1)
          
          print()
          print("================================")
          print("ğŸ‰ éƒ¨ç½²å®Œæˆï¼")
          print("================================")
          print()
          print("ğŸ“ API ç«¯é»ï¼š")
          print(f"   å¥åº·æª¢æŸ¥ï¼šhttps://{username}-{space_name}.hf.space/health")
          print(f"   API æ–‡ä»¶ï¼šhttps://{username}-{space_name}.hf.space/docs")
          print(f"   åˆ†æç«¯é»ï¼šhttps://{username}-{space_name}.hf.space/api/v1/analyze")
          print()
          print("ğŸ§ª æ¸¬è©¦æŒ‡ä»¤ï¼š")
          print(f"   curl https://{username}-{space_name}.hf.space/health")
          print()
          print("â³ æ³¨æ„ï¼šHuggingFace Space éœ€è¦ 2-5 åˆ†é˜å•Ÿå‹•")
          print("   è«‹ç¨å¾Œè¨ªå•ä¸Šé¢çš„ URL")
          print("================================")
          PYDEPLOY

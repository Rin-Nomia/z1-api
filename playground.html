<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Continuum - API Playground</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #0a0a0a;
      color: #e0e0e0;
      padding: 20px;
      line-height: 1.6;
    }

    .container { max-width: 800px; margin: 0 auto; }
    header { text-align: center; margin-bottom: 40px; }

    h1 { font-size: 2em; margin-bottom: 10px; color: #fff; }
    .tagline { color: #888; font-size: 0.9em; margin-bottom: 8px; }

    .notice {
      background: #1a2332;
      border: 1px solid #2d3e54;
      border-radius: 6px;
      padding: 12px;
      color: #88b3ff;
      font-size: 0.85em;
      text-align: center;
      margin-top: 12px;
    }
    .notice strong { color: #4a9eff; }

    .input-section {
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .example-buttons {
      margin-top: 15px;
      margin-bottom: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: center;
    }

    .example-btn {
      width: auto;
      padding: 8px 16px;
      background: #2d3e54;
      font-size: 0.85em;
      border: none;
      border-radius: 4px;
      color: #fff;
      cursor: pointer;
      transition: background 0.2s;
    }

    .example-btn:hover { background: #3d4e64; }

    .char-counter {
      text-align: right;
      color: #666;
      font-size: 0.85em;
      margin-top: 8px;
    }
    .char-counter.warning { color: #ff922b; }
    .char-counter.good { color: #51cf66; }

    textarea {
      width: 100%;
      min-height: 120px;
      background: #0a0a0a;
      border: 1px solid #333;
      border-radius: 4px;
      padding: 12px;
      color: #e0e0e0;
      font-size: 1em;
      resize: vertical;
      font-family: inherit;
    }
    textarea:focus { outline: none; border-color: #4a9eff; }

    button {
      width: 100%;
      background: #4a9eff;
      color: #fff;
      border: none;
      border-radius: 4px;
      padding: 12px;
      font-size: 1em;
      font-weight: 600;
      cursor: pointer;
      margin-top: 15px;
      transition: background 0.2s;
    }
    button:hover { background: #3a8eef; }
    button:disabled { background: #333; cursor: not-allowed; }

    .result-section {
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 8px;
      padding: 20px;
      display: none;
    }
    .result-section.show { display: block; }

    .result-item {
      margin-bottom: 20px;
      padding-bottom: 20px;
      border-bottom: 1px solid #333;
    }
    .result-item:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }

    .result-label {
      color: #888;
      font-size: 0.85em;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    .result-value { color: #fff; font-size: 1.05em; }

    .note-box {
      background: #1a2332;
      border-left: 3px solid #4a9eff;
      padding: 12px;
      margin-top: 12px;
      color: #88b3ff;
      font-size: 0.9em;
      border-radius: 4px;
    }

    .tone-badge, .mode-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 0.9em;
      font-weight: 600;
      margin-right: 8px;
    }

    .tone-anxious { background: #ff6b6b; color: #fff; }
    .tone-cold { background: #4dabf7; color: #fff; }
    .tone-sharp { background: #ff922b; color: #fff; }
    .tone-blur { background: #868e96; color: #fff; }
    .tone-pushy { background: #f783ac; color: #fff; }
    .tone-unknown { background: #333; color: #888; }
    .tone-outofscope { background: #7b2cbf; color: #fff; }

    .mode-repair { background: #2f9e44; color: #fff; }
    .mode-suggest { background: #f08c00; color: #fff; }
    .mode-no-op { background: #495057; color: #fff; }

    .confidence {
      display: inline-block;
      color: #888;
      font-size: 0.9em;
      margin-left: 4px;
    }
    .confidence.low { color: #ff922b; }
    .confidence.medium { color: #ffd43b; }
    .confidence.high { color: #51cf66; }

    .error {
      background: #2d1f1f;
      border: 1px solid #ff6b6b;
      border-radius: 4px;
      padding: 12px;
      color: #ff6b6b;
      margin-top: 15px;
      font-size: 0.9em;
    }

    footer {
      text-align: center;
      margin-top: 40px;
      padding-top: 20px;
      border-top: 1px solid #333;
      color: #666;
      font-size: 0.85em;
    }
    footer a { color: #4a9eff; text-decoration: none; }
    footer p { margin: 8px 0; }
  </style>
</head>

<body>
<div class="container">
  <header>
    <h1>ðŸ’Ž Continuum</h1>
    <p class="tagline">RIN Protocol â€” Tone Rhythm Repair Module</p>
    <div class="notice">
      <strong>ðŸ’¡ Best Practice:</strong> Enter complete sentences (15+ characters recommended) for accurate tone analysis
    </div>
  </header>

  <div class="input-section">
    <textarea id="inputText"
      placeholder="Enter a complete sentence for best results (15+ characters recommended)...

Try these examples:

Anxious:
- I've been struggling with this for weeks and nothing seems to help me at all.
- I don't even know why I'm telling you this anymore, you probably can't help anyway.

Sharp:
- Can you just give me a straight answer instead of asking more questions?
- Honestly I'm just really tired of explaining the same thing over and over again.

Cold:
- I understand. Let's focus on what you can control.

Note: Messages under 15 characters may not provide accurate tone analysis."
    ></textarea>

    <div class="example-buttons">
      <button type="button" class="example-btn" onclick="loadExample(1)">Anxious Example</button>
      <button type="button" class="example-btn" onclick="loadExample(2)">Sharp Example</button>
      <button type="button" class="example-btn" onclick="loadExample(3)">Cold Example</button>
    </div>

    <div id="charCounter" class="char-counter">0 characters</div>
    <button id="analyzeBtn" onclick="analyzeText()">Analyze Tone</button>
    <div id="errorMsg" class="error" style="display:none;"></div>
  </div>

  <div id="resultSection" class="result-section">
    <div class="result-item">
      <div class="result-label">Decision</div>
      <div class="result-value" id="decisionLine"></div>
    </div>

    <div class="result-item">
      <div class="result-label">Original Text</div>
      <div class="result-value" id="originalText"></div>
    </div>

    <div class="result-item">
      <div class="result-label" id="outputLabel">Output</div>
      <div class="result-value" id="outputText"></div>
      <div id="noteBox" class="note-box" style="display:none;"></div>
    </div>

    <div class="result-item">
      <div class="result-label">Scenario</div>
      <div class="result-value" id="scenario"></div>
    </div>
  </div>

  <footer>
    <p><strong>Continuum</strong> â€” RIN Protocol | Tone Rhythm Repair Module</p>
    <p>API: <a href="https://rinnomia-continuum-api.hf.space/docs" target="_blank">rinnomia-continuum-api.hf.space</a></p>
    <p style="margin-top: 10px; font-size: 0.8em; color: #666;">
      Best results with full sentences. Short phrases may show limited analysis.
    </p>
  </footer>
</div>

<script>
  const API_URL = 'https://rinnomia-continuum-api.hf.space/api/v1/analyze';

  const examples = {
    1: "I've been struggling with this for weeks and nothing seems to help me at all.",
    2: "Can you just give me a straight answer instead of asking more questions?",
    3: "I understand. Let's focus on what you can control."
  };

  function loadExample(num) {
    const el = document.getElementById('inputText');
    el.value = examples[num];
    updateCounter();
  }

  const inputEl = document.getElementById('inputText');
  inputEl.addEventListener('input', updateCounter);

  function updateCounter() {
    const count = inputEl.value.trim().length;
    const counter = document.getElementById('charCounter');
    counter.textContent = `${count} character${count !== 1 ? 's' : ''}`;
    counter.className = (count < 15) ? 'char-counter warning' : 'char-counter good';
  }

  async function analyzeText() {
    const text = inputEl.value.trim();
    const analyzeBtn = document.getElementById('analyzeBtn');
    const resultSection = document.getElementById('resultSection');
    const errorMsg = document.getElementById('errorMsg');

    errorMsg.style.display = 'none';
    resultSection.classList.remove('show');

    if (!text) return showError('Please enter text to analyze');

    analyzeBtn.disabled = true;
    analyzeBtn.textContent = 'Analyzing...';

    try {
      const response = await fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ text })
      });

      if (!response.ok) throw new Error(`API error: ${response.status}`);

      const data = await response.json();
      displayResults(data);

    } catch (err) {
      showError(`Analysis failed: ${err.message}`);
    } finally {
      analyzeBtn.disabled = false;
      analyzeBtn.textContent = 'Analyze Tone';
    }
  }

  // ----------------------------
  // âœ… robust getters (new API first, old API fallback)
  // ----------------------------
  function _getConfidenceFinal(data) {
    // New API: confidence.final
    if (data && data.confidence && typeof data.confidence === 'object') {
      const v = Number(data.confidence.final);
      if (Number.isFinite(v)) return v;
    }
    // Old API: confidence_final
    if (data && data.confidence_final !== undefined) {
      const v = Number(data.confidence_final);
      if (Number.isFinite(v)) return v;
    }
    // Old old API: confidence (number)
    if (data && typeof data.confidence === 'number') {
      const v = Number(data.confidence);
      if (Number.isFinite(v)) return v;
    }
    return 0;
  }

  function _getScenario(data) {
    // New API: output.scenario
    if (data && data.output && typeof data.output === 'object' && data.output.scenario) {
      return String(data.output.scenario);
    }
    // Old API: scenario
    if (data && data.scenario) return String(data.scenario);
    return 'Unclassified';
  }

  function _getRepairNote(data) {
    // New API: output.repair_note
    if (data && data.output && typeof data.output === 'object' && data.output.repair_note) {
      return String(data.output.repair_note);
    }
    // Legacy: repair_note
    if (data && data.repair_note) return String(data.repair_note);
    return '';
  }

  function _getOutputTextByMode(data, modeLower) {
    // New API: output.repaired_text preferred for repair/suggest/no-op
    const normalized = (data && (data.normalized || data.original)) ? String(data.normalized || data.original) : '';
    const original = (data && data.original) ? String(data.original) : normalized;

    if (data && data.output && typeof data.output === 'object') {
      const outText = (data.output.repaired_text !== undefined && data.output.repaired_text !== null)
        ? String(data.output.repaired_text)
        : '';

      if (modeLower === 'repair' || modeLower === 'suggest') {
        return outText || normalized || original || '';
      }
      // no-op: show normalized (transparent pass-through)
      return normalized || original || '';
    }

    // Legacy fallbacks
    if (modeLower === 'repair' || modeLower === 'suggest') {
      if (data && data.repaired_text) return String(data.repaired_text);
      return normalized || original || '';
    }
    return normalized || original || '';
  }

  function displayResults(data) {
    const resultSection = document.getElementById('resultSection');

    const decisionLine = document.getElementById('decisionLine');
    const originalTextEl = document.getElementById('originalText');
    const outputLabel = document.getElementById('outputLabel');
    const outputText = document.getElementById('outputText');
    const noteBox = document.getElementById('noteBox');
    const scenarioEl = document.getElementById('scenario');

    const freq = (data && data.freq_type) ? String(data.freq_type) : 'Unknown';
    const freqLower = freq.toLowerCase();

    // mode (new API), fallback if old API
    let mode = (data && data.mode) ? data.mode : null;
    if (!mode) {
      // fallback heuristic:
      if (freq === 'Unknown') mode = 'no-op';
      else if (data && data.repaired_text && data.original && data.repaired_text !== data.original) mode = 'repair';
      else mode = 'suggest';
    }
    const modeLower = String(mode).toLowerCase();

    // âœ… confidence (robust)
    let confFinal = _getConfidenceFinal(data);
    if (!Number.isFinite(confFinal)) confFinal = 0;
    confFinal = Math.max(0, Math.min(1, confFinal));

    const confPercent = (confFinal * 100).toFixed(0);

    let confClass = 'confidence';
    if (confFinal >= 0.7) confClass += ' high';
    else if (confFinal >= 0.4) confClass += ' medium';
    else confClass += ' low';

    // âœ… Decision line
    decisionLine.innerHTML = `
      <span class="tone-badge tone-${freqLower}">${freq}</span>
      <span class="mode-badge mode-${modeLower}">${modeLower.toUpperCase()}</span>
      <span class="${confClass}">${confPercent}% confidence</span>
    `;

    // Original text
    originalTextEl.textContent = (data && data.original) ? String(data.original) : '';

    // âœ… Scenario (new API: output.scenario)
    scenarioEl.textContent = _getScenario(data);

    // âœ… Note (new API: output.repair_note)
    const note = _getRepairNote(data);
    if (note) {
      noteBox.textContent = note;
      noteBox.style.display = 'block';
    } else {
      noteBox.style.display = 'none';
    }

    // âœ… Output rendering by mode (no more "No repair needed" lie)
    if (modeLower === 'repair') {
      outputLabel.textContent = 'Repaired Text';
    } else if (modeLower === 'suggest') {
      outputLabel.textContent = 'Suggestion Output';
    } else {
      outputLabel.textContent = 'Transparent Pass-through';
    }

    outputText.textContent = _getOutputTextByMode(data, modeLower);

    resultSection.classList.add('show');
  }

  function showError(message) {
    const errorMsg = document.getElementById('errorMsg');
    errorMsg.textContent = message;
    errorMsg.style.display = 'block';
  }

  document.getElementById('inputText').addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      analyzeText();
    }
  });

  updateCounter();
</script>
</body>
</html>